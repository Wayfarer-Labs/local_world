name: build-windows-exe

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure 7-Zip is available
        shell: pwsh
        run: |
          $sevenZip = Join-Path ${env:ProgramFiles} '7-Zip\7z.exe'
          if (-not (Test-Path $sevenZip)) {
            choco install 7zip -y
          }

      - name: Stage files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist\stage | Out-Null
          Copy-Item packaging\LocalWorld.cmd dist\stage\
          Copy-Item pixi.toml dist\stage\
          Copy-Item src\client.py dist\stage\client.py

      - name: Build self-extracting EXE (7-Zip SFX)
        shell: pwsh
        run: |
          $stage    = (Resolve-Path 'dist\stage').Path
          $sevenZip = Join-Path ${env:ProgramFiles} '7-Zip\7z.exe'

          $sfx = Join-Path ${env:ProgramFiles} '7-Zip\7z.sfx'
          if (-not (Test-Path $sfx)) {
            $sfx = Join-Path ${env:ProgramFiles} '7-Zip\7zCon.sfx'
          }

          if (-not (Test-Path $sevenZip)) { throw "7z.exe not found at $sevenZip" }
          if (-not (Test-Path $sfx))     { throw "7z SFX module not found (expected 7z.sfx or 7zCon.sfx)" }

          Push-Location $stage

          & $sevenZip a -t7z payload.7z * | Out-Host

          @"
;!@Install@!UTF-8!
Title="LocalWorld"
RunProgram="LocalWorld.cmd"
;!@InstallEnd@!
"@ | Set-Content -Encoding utf8 config.txt

          cmd /c "copy /b `"$sfx`"+config.txt+payload.7z LocalWorld.exe" | Out-Host

          Write-Host "Stage contents:"
          Get-Chi
