name: build-windows-exe

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure 7-Zip is available
        shell: pwsh
        run: |
          $sevenZip = "${env:ProgramFiles}\7-Zip\7z.exe"
          if (-not (Test-Path $sevenZip)) {
            choco install 7zip -y
          }

      - name: Stage files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist\stage | Out-Null
          Copy-Item packaging\LocalWorld.cmd dist\stage\
          Copy-Item pixi.toml dist\stage\
          Copy-Item src\client.py dist\stage\client.py

      - name: Build self-extracting EXE (7-Zip SFX)
        shell: pwsh
        run: |
          $stage    = (Resolve-Path dist\stage).Path
          $sevenZip = "${env:ProgramFiles}\7-Zip\7z.exe"
          $sfxA     = "${env:ProgramFiles}\7-Zip\7z.sfx"
          $sfxB     = "${env:ProgramFiles}\7-Zip\7zCon.sfx"
          $sfx      = (Test-Path $sfxA) ? $sfxA : $sfxB

          if (-not (Test-Path $sevenZip)) { throw "7z.exe not found" }
          if (-not (Test-Path $sfx))     { throw "7z SFX module not found" }

          Push-Location $stage
          & $sevenZip a -t7z payload.7z * | Out-Host

          @'
;!@Install@!UTF-8!
Title="LocalWorld"
RunProgram="LocalWorld.cmd"
;!@InstallEnd@!
'@ | Set-Content -Encoding utf8 config.txt

          cmd /c "copy /b `"$sfx`"+config.txt+payload.7z LocalWorld.exe"
          Pop-Location

      - name: Upload exe
        uses: actions/upload-artifact@v4
        with:
          name: LocalWorld
          path: dist/stage/LocalWorld.exe
