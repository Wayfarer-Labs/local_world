name: build-windows-exe

on:
  workflow_dispatch:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: prefix-dev/setup-pixi@v0.8.3
        with:
          cache: false

      - name: Build wheel
        shell: pwsh
        run: |
          python -m pip install --upgrade pip build
          python -m build --wheel

      - name: Lock + install env (so pixi.lock exists and deps resolve)
        shell: pwsh
        run: |
          pixi lock
          pixi install

      - name: Create portable environment.ps1 (pixi-pack)
        shell: pwsh
        run: |
          pixi exec --spec "pixi-pack" pixi-pack --create-executable --platform win-64 pixi.toml

      - name: Stage files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist\stage | Out-Null
          Copy-Item packaging\LocalWorld.cmd dist\stage\
          Copy-Item pixi.toml dist\stage\
          if (Test-Path pixi.lock) { Copy-Item pixi.lock dist\stage\ }
          Copy-Item src\client.py dist\stage\client.py

      - name: Build single EXE with IExpress
        shell: pwsh
        run: |
          $stage = (Resolve-Path dist\stage).Path
          $sed   = Join-Path $stage "foo.sed"
          $out   = Join-Path $stage "LocalWorld.exe"

          @"
          [Version]
          Class=IExpress
          SEDVersion=3
          [Options]
          PackagePurpose=InstallApp
          ShowInstallProgramWindow=0
          HideExtractAnimation=1
          UseLongFileName=1
          InsideCompressed=1
          RebootMode=N
          InstallPrompt=
          DisplayLicense=
          FinishMessage=
          FriendlyName=LocalWorld
          TargetName=$out
          AppLaunched=cmd.exe /c LocalWorld.cmd
          SourceFiles=SourceFiles

          [SourceFiles]
          SourceFiles0=$stage

          [SourceFiles0]
          LocalWorld.cmd
          pixi.toml
          pixi.lock
          client.py
          "@ | Set-Content -Encoding ASCII $sed

          & "$env:WINDIR\System32\IExpress.exe" /N $sed

      - name: Upload exe
        uses: actions/upload-artifact@v4
        with:
          name: LocalWorld
          path: dist/stage/LocalWorld.exe
